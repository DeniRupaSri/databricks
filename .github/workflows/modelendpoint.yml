name: Deploy Model Endpoint
 
on:
  workflow_dispatch:
    inputs:
      model_name:
        description: "Enter registered model name"
        required: true
      model_version:
        description: "Enter model version to deploy"
        required: true
 
jobs:
  deploy-endpoint:
    runs-on: ubuntu-latest
 
    steps:
      - uses: actions/checkout@v4
 
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
 
      - name: Create and Run Job
        id: runjob
        run: |
          export DATABRICKS_HOST="https://adb-1670050298591902.2.azuredatabricks.net"
          export DATABRICKS_TOKEN="dapi4b40ad1ece89a527393ae3e677e48b76-3"
 
          # Create job using deploy JSON and capture ID
          JOB_ID=$(databricks jobs create --json @Endpoint.json | jq -r '.job_id')
 
          # Run job and pass parameters for deployment
          RUN_ID=$(databricks jobs run-now \
            --json "{\"job_id\": $JOB_ID, \"notebook_params\": {\"model_name\": \"${{ github.event.inputs.model_name }}\", \"model_version\": \"${{ github.event.inputs.model_version }}\"}}" \
            | jq -r '.run_id')
 
          echo "RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT
 
 
      - name: Show Endpoint URL in GitHub Logs
        run: |
          export DATABRICKS_HOST="https://adb-1670050298591902.2.azuredatabricks.net"
          export DATABRICKS_TOKEN="dapi4b40ad1ece89a527393ae3e677e48b76-3"
          # Get task run ID for Deploy_Endpoint task
          TASK_RUN_ID=$(databricks jobs get-run ${{ steps.runjob.outputs.RUN_ID }} | jq -r '.tasks[] | select(.task_key=="Endpoint") | .run_id')
          # Fetch only the task output
          OUTPUT=$(databricks jobs get-run-output $TASK_RUN_ID | jq -r '.notebook_output.result')
          echo "::notice title=ðŸ”— Serving Endpoint::$OUTPUT"
 
